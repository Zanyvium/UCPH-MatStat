---
title: "MatStat Eksamen 2021"
author: "Eksamens nummer: 1"
header-includes:
   - \usepackage[utf8]{inputenc}
   - \usepackage{verbatim}
   - \usepackage[language]{babel}
   - \usepackage[encoding]{inputenc}
   - \usepackage{hyperref}
   - \usepackage{amsmath}
   - \usepackage{mathtools}
   - \usepackage{amssymb}
   - \usepackage{mathtools}
   - \usepackage{nicefrac}
   - \usepackage{fullpage}
   - \usepackage{stmaryrd}
   - \usepackage{aligned-overset}
   - \usepackage{pdfpages}
date: "Eksamensdato `r format(Sys.time(), '%d. %B, %Y')`"
# Hvordan får  vi den til at printe February i stedet for februar??????
output: html_document
---

------------------------------------------------------------------------

```{=html}
<!-- RMD tips:
1. CTRL+SHIFT+C RMD-comments-out the selected lines, with in a standard HTML comment-out format. 

2. CTRL+ALT+I inserts a new r codechunck

3. Pressing CTRL+SHIFT+ENTER when over a code chunck gives you a preview of the results of the chunck

4. CTRL+SHIFT+K gives you a preview of the entire resulting HTML file.

5. Note the different results of '#HS 1' and 
'# HS 1' (without the '') in the output

6. It is possible to compile regular R-scripts into Rmd files - this is done by pressing CTRL+SHIFT+K while attending any R-script. <<<- Though this apparently doesn't work for HS Problems.R for some reason!?!?!? ->>>

7. Selective use of the echo=c(...) option within code chuncks allows assignment of a variable, to show the assignment in the knitted document, and showing the value of the assignment seamlessly as well - see HS2.3

8. It is possible to include results of R-analysis such as summary statistics in LaTeX-equations in RMD, see HS2.3

9. Adding fig.align="center" to a code chunk centers any figures generated by the chunck.

9.1 note that properties of codechunks seem casesensitive; fig.align="center" centers a figure, but fig.align="Center" (with capital C) doesn't

10. A new subtitle needs a blank line before itself: 
'works:

#### HS 7
'

'doesn't:
blablabla
#### HS 7
'

'doesn't either:
<!-- blablabla ->
#### HS 7
'
11. Pressing F7 when marking, or hovering over a word will spellcheck the word

12. CTRL + - (minus) zooms out, CTRL + + (plus) zooms in

13. CTRL + D Deletes the current line, or current selection of lines

14. THE FOLLOWING SOURCE EDITOR FOLDING METHODS:
14.1 Collapse current fold: ALT + L
14.1.1: Expand current fold: SHIFT + ALT + L
14.2 Collapse "all" subfolds: ALT + O <- !?!! Note that this leaves a small letter 'o' in the text !!?!
14.2.1 Expand "all" subfolds: SHIFT + ALT + O
14.3 Collapse all other folds: ALT + 0 (zero)

15. SHIFT + ALT + J allows you to jump to specific parts of the document

16. Writing a new line with '...' will cause all previous output to be hidden in the knittet document

17. Writing (q<-5) around R code, will both assign and print the code upon assignment 

18. Note that 'attach' only has the scope of the current R-chunck.

19. One way to get pdf printout is to compile a html-printout, and then, in-browser, 'print' the HTML page as a pdf.
-->
```
<!-- ---?--- How do I create a closeable Rmd section, such that I do not have to scroll through the LaTeX commands each time? - !!! Can be done with '-----' through this also creates a line in the knittet document. -->

<!-- How do I publish and share the HTML as a viewable (and linkable) website - this can be done through github? -->

<!-- How can I share R markdown files such that multiple people can edit them at the same time? -->

<!-- Do we need parindent controls as in LaTeX? -->

<!-- Use of the cache function to reduce recompile times -->

<!-- How to close current subsection with a keyboard shortcut? How to close subsubsections,...? - !!!See RMD tip 14!!! -->

<!-- Chunk naming? -->

<!-- How to define variables such that they have scope within their own ## segment? -->

<!-- How do I delete all non-needed variables for each new section in R??? -->

<!-- LaTeX commands -->

\newcommand{\C}{\mathbb{C}} <!--- Komplekse tal --->

\newcommand{\R}{\mathbb{R}} <!--- Reelle tal--->

\newcommand{\Q}{\mathbb{Q}}

<!---Rationelle tal--->

\newcommand{\Z}{\mathbb{Z}}

<!---Hele tal--->

\newcommand{\N}{\mathbb{N}}

<!---Naturlige tal--->

\newcommand{\E}{\mathbb{E}}

<!---mean--->

\newcommand{\F}{\mathbb{F}}

<!---Baggrundsrum sigma-alg--->

\newcommand{\B}{\mathbb{B}}

<!---Borel sigma--->

\newcommand{\K}{\mathbb{K}}

<!---Generel field--->

\newcommand{\RB}{\overline{\R}}

<!---Udvidede reelle tal--->


\newcommand{\ms}[1]{\mathscr{#1}}
\newcommand{\mc}[1]{\mathcal{#1}}
\newcommand{\BR}{\mathcal{B}\left(\R\right)} <!---Borel på Reelle tal -->
\newcommand{\BRB}{\mathcal{B}\left(\RB\right))} <!---Borel på udvidede reelle tal -->


\newcommand{\mf}[1]{\mathfrak{#1}} 
\newcommand{\mcG}[2]{\mathcal{#1}^1(#2)} 
\newcommand{\mcGG}[4]{\mathcal{#1}_{#3}^{#2}(#4)}
\newcommand{\GMR}{\left(X,\ms{A},\mu\right)} <!---Generelt målrum -->

\newcommand{\PBS}{\lrp{\Omega,\F, P}}

<!--- Probability background space -->

\newcommand{\RMR}{\left(\R,\BR, \lambda\right)}

<!---Reelt målrum, m. Borel, og lebesgue mål. -->

\newcommand{\MRBPBR}{\mc{M}_{\RB}^+\left(\BR\right)}

<!---Mængden af positive målelige funktioner som sender (R,BR) over i (RB, BRB) -->

\newcommand{\MRPBR}{\mc{M}_{\R}^+\left(\BR\right)}

<!---Mængden af positive målelige funktioner som sender (R,BR) over i (R, BR) -->

<!---L_p spaces on [0,1] with m -->


\newcommand{\Lp}[1]{L_{#1}\lrp{\lrs{0,1},m}} 
\newcommand{\mclxy}{\mc{L}\lrp{X,Y}}

<!---Bounded linear functionals from X to Y -->

\newcommand{\mckxy}{\mc{K}\lrp{X,Y}}

<!---Compact Bounded linear functionals from X to Y -->

\newcommand{\mssr}{\ms{S}(\R)}

<!---The Schwartz space on $\R$ -->

<!---Arrows -->

\newcommand{\ra}{\rightarrow} <!---Konvergens pil højre -->
\newcommand{\nra}{\nrightarrow} <!---ikke Konvergens pil højre -->
\newcommand{\la}{\leftarrow} <!---Konv pil venstre -->
\newcommand{\nla}{\nleftarrow} <!---ikke Konvergens pil venstre -->
\newcommand{\lra}{\leftrightarrow} <!---højre venstre pil -->
\newcommand{\nlra}{\nleftrightarrow} <!---ikke højre venstre pil -->
\newcommand{\hra}{\hookrightarrow} <!---Injektiv  pil højre -->
\newcommand{\Ra}{\Rightarrow} <!---Implikations pil højre -->
\newcommand{\Lra}{\Leftrightarrow} <!---Bi-implikations pil -->
\newcommand{\Uda}{\Updownarrow} <!---Bi-implikations pil (op og ned) -->
\newcommand{\Da}{\Downarrow} <!---implikations pil (ned) -->
\newcommand{\rhpu}{\rightharpoonup} <!---Weak convergence in Hilbert spaces -->

<!-- LHS & RHS calculations -->

\newcommand{\swel}{\overset{\swarrow}{=}} <!---Continue calculation on left hand side with equality -->
\newcommand{\sweq}{\overset{\swarrow}{\equiv}} <!---Continue calculation on left hand side with equivalence -->
\newcommand{\seel}{\overset{\searrow}{=}} <!---Continue calculation on right hand side with equality -->
\newcommand{\seeq}{\overset{\searrow}{\equiv}} <!---Continue calculation on right hand side with equivalence -->
\newcommand{\inse}{\overset{\cdot}{=}} <!--- Insert values in calculation -->

\newcommand{\PMX}{\mc{P}\left(X\right)} <!---Potensmængde af X -->
\newcommand{\comp}{\mathsf{c}} <!---Set compliment -->
\newcommand{\sm}{\setminus} <!---mængdedifferens -->

<!--- Parenteser --->
\newcommand{\lrp}[1]{\mathopen{}\left({#1}\right)\mathclose{}} <!-- \left("STUFF"\right) -->
\newcommand{\lrc}[1]{\mathopen{}\left\{{#1}\right\}\mathclose{}} <!-- \left\{"STUFF"\right\} -->
\newcommand{\lrs}[1]{\mathopen{}\left[{#1}\right]\mathclose{}} <!-- \left["STUFF"\right] -->
\newcommand{\lrb}[1]{\mathopen{}\left|{#1}\right|\mathclose{}} <!-- \left|"STUFF"\right| -->
\newcommand{\inner}[2]{\mathopen{}\left\langle #1, #2 \right\rangle\mathclose{}}  <!-- <\left"STUFF1","STUFF2"\right> -->
\newcommand{\norm}[1]{\mathopen{}\left\lVert#1\right\rVert\mathclose{}} <!-- \left||"STUFF"\right|| -->
\newcommand{\floor}[1]{\lfloor #1 \rfloor} <!---Floor function --->
\newcommand{\ceil}[1]{\lceil #1 \rceil} <!---ceil --->
\newcommand{\FFou}[1]{\mc{F}(#1)} <!---Fourier Transform notation 1 --->
\newcommand{\Fou}[1]{\widehat{#1}} <!---Fourier Transform notation 2 --->

<!--- Farver --->
\newcommand{\blue}[1]{\textcolor{blue}{{#1}}} <!--- Turning text blue --->
\newcommand{\red}[1]{\textcolor{red}{{#1}}} <!--- Turning text red --->
\newcommand{\green}[1]{\textcolor{green}{{#1}}} <!--- Turning text green --->
\newcommand{\purple}[1]{\textcolor{purple}{{#1}}} <!--- Turning text purple --->
\newcommand{\cyan}[1]{\textcolor{cyan}{{#1}}} <!--- Turning text cyan --->
\newcommand{\orange}[1]{\textcolor{orange}{{#1}}} <!--- Turning text orange --->

<!--- Oversetting bold accents --->
\newcommand{\boldhat}[1]{\mathbf{\hat{\text{$#1$}}}}
\newcommand{\boldbar}[1]{\mathbf{\bar{\text{$#1$}}}}
\newcommand{\boldtilde}[1]{\mathbf{\tilde{\text{$#1$}}}}
\newcommand{\boldcheck}[1]{\mathbf{\check{\text{$#1$}}}}

\newcommand{\indep}{\perp \!\!\! \perp} <!---independence --->
\newcommand{\colvec}[1]{\begin{pmatrix}{#1}\end{pmatrix}} <!-- Begin column vector - Doesn't seem to work with non-column vectors...-->


\newcommand{\nd}[2]{\mc{N}\lrp{{#1},{#2}}} <!-- Normal distribution -->
\newcommand{\dnd}[2]{\sim\mc{N}\lrp{{#1},{#2}}} <!-- Distributed as Normal distribution -->

<!-- \newcommand{\Rlogo}{![](R_logo.png){#id .class width=auto height=16px} } <!-- R logo implemented in text -->

<!-- Image insertion alla LaTeX doesn't seem to work too well..., but inserting the above gives the desired effect. -->

<!--???? \declareMathOperator{\SE}{SE} DOESN'T REALLY SEEM TO WORK????-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE) #semi-dangerous to set cache true globally :||
library(tidyverse)
library(gridExtra)
theme_set(theme_minimal())
library(MASS)
set.seed(314)
varnametotext <- function(v){
   deparse(substitute(v))
}
Stdresplot <- function(model, main = paste("(Estimate, Std. Res.)-plot of", deparse(substitute(model))), ylab ="Standardized residuals", ...) {
 fit <- fitted(model)
 rst <- rstandard(model)
 qplot(fit, rst, main = main, ylab = ylab, ylim = c(-max(3.2,max(abs(rst))), max(3.2,max(abs(rst)))) )+geom_hline(yintercept = 0) #Largest symmetric interval (around 0) of (-3.2,3.2) or (-largest absolute rst, largest absolute rst)
}
QQplotdraw <- function(model, main = paste("Normal QQ-plot of", deparse(substitute(model))), xlab = "Theoretical Quantiles", ylab ="Sample Quantiles", ...) {
   rst <- rstandard(model)
   #dataname <- getCall(lm_LT)$data
   ggplot(data = eval(getCall(model)$data), main = main, xlab = xlab, ylab = ylab) + geom_qq() + geom_qq_line() + aes(sample = rst)
} #main, xlab, ylab call do not work for some reason
StdresQQPlot <- function(model,...) {
   p1 <- Stdresplot(model,...)
   p2 <- QQplotdraw(model,...)
   #library(gridExtra)
   grid.arrange(p1,p2, ncol = 2)
}
```


## **Opgave 2**
Vi kan starte med at indlæse data:
```{r}
library(tidyverse)
vaccine <- read_csv("covid19vaccine.txt", col_types = cols(U = col_factor(), T = col_factor()))
```

<!-- og bruge `relevel` kommando til at få korrekt referencegruppe (placebo) til vaccinenationer: -->
<!-- ```{r} -->
<!-- levels(vaccine$T) -->
<!-- vaccine$T <- relevel(vaccine$T, ref = "PL") -->
<!-- levels(vaccine$T) -->
<!-- ``` -->

#### **Opgave 2.1**
(Primære besvarelse af opgaven her i R)

Vi er i delopgave 2.1 og 2.2 blevet bedt om kun at bruge datasættet for `vaccine_uge5`, som er givet ved
```{r}
vaccine_uge5 <- filter(vaccine, U == 5)
```

Vi kan yderligere subsette vores datasæt ved;
```{r}
vaccine_uge5Ind <- subset(vaccine_uge5, select = c(3,5))
head(vaccine_uge5Ind)
```

Vi kan på basis af dette fitte to `lm` modeller ud fra faktoren `T`, med respons hhv. $X,\,log(X)$. Dette kan gøres i R ved følgende:

```{r}
model <- lm(X~T,data=vaccine_uge5Ind)
logmodel <- lm(log(X)~T,data=vaccine_uge5Ind)
```

Følgende hjemmelavede plotfunktion benyttes til at plotte hhv. std. res. og QQplot for hver af de to modeller.

```{r}
library(gridExtra)
Stdresplot <- function(model, main = paste("(Estimate, Std. Res.)-plot of", deparse(substitute(model))), ylab ="Standardized residuals", ...) {
 fit <- fitted(model)
 rst <- rstandard(model)
 qplot(fit, rst, main = main, ylab = ylab, ylim = c(-max(3.2,max(abs(rst))), max(3.2,max(abs(rst)))) )+geom_hline(yintercept = 0) #Largest symmetric interval (around 0) of (-3.2,3.2) or (-largest absolute rst, largest absolute rst)
}
QQplotdraw <- function(model, main = paste("Normal QQ-plot of", deparse(substitute(model))), xlab = "Theoretical Quantiles", ylab ="Sample Quantiles", ...) {
   rst <- rstandard(model)
   #dataname <- getCall(lm_LT)$data
   ggplot(data = eval(getCall(model)$data), main = main, xlab = xlab, ylab = ylab) + geom_qq() + geom_qq_line() + aes(sample = rst)
} #main, xlab, ylab call do not work for some reason
StdresQQPlot <- function(model,...) {
   p1 <- Stdresplot(model,...)
   p2 <- QQplotdraw(model,...)
   #library(gridExtra)
   grid.arrange(p1,p2, ncol = 2)
}
```
Således at vi kan plotte:
```{r, fig.align="center"}
StdresQQPlot(model)
StdresQQPlot(logmodel)
```

I forhold til modelhypotesen for et ensidet faktor-analyse, kan det på overstående plot ses, at det log-transformerede plot passer langt bedre til antagelserne. Specifikt ser vi at vi ved at log-transformerer får tæmmet de 'outliers' vi har på std. res. plottet for den ikke-transformerede model, således at vi i højere grad kan være tilfredse med linearitets antagelsen i et-faktor modellen. - hertil ser vi at varians homogeniteten ser bedre ud i `logmodel` og specielt ser vi fra QQplottet at det er meget mere rimeligt med normalfordelingsantagelsen, når vi først har log-transformeret. - Vi vil derfor arbejde videre med `logmodel`. 

#### **Opgave 2.2**
(Primære besvarelse af opgaven her i R)

For at analyserer om der er nogen forskel i effekt ved hver af de to vacciner kan vi kigge på summary;

```{r}
summary(logmodel)
```
Vi har `KK` som intercept parameter, og tester i anden ligne forskellen mellem `KK` og `VZ`. Det er her værd at bemærke den enormt store $p$ værdi på `0.975` understøtter hypotesen om at der ikke er signifikant forskel mellem logeffekten af VZ og KK vaccinen - hvilket også er understøttet af estimatet for forskellen som er ret lavt som `r coef(logmodel)[[2]]`. 
<!-- # ```{r} -->
<!-- # boxplot(log(X)~T, data=vaccine_uge5Ind) -->
<!-- # confint(logmodel) -->
<!-- # ``` -->
<!-- #  -->
<!-- #  -->
<!-- #  -->
<!-- # ```{r} -->
<!-- # logmodel1 <- lm(log(X)~1,data=vaccine_uge5Ind) -->
<!-- # anova(logmodel1, logmodel) -->
<!-- # anova(logmodel) -->
<!-- # ``` -->

#### **Opgave 2.3**
(Se besvarelses forklaring på papir)

Vi laver tabel for forskellige faktorer;
```{r}
table(vaccine$S, vaccine$U) #"fuld rang": 10 niveauer
table(vaccine$T, vaccine$U) #"fuld rang": 15 niveauer
table(vaccine$T, interaction(vaccine$U,vaccine$S)) #"fuld rang": 15 niveauer
```

#### **Opgave 2.4**
(Primære besvarelse af første del af opgaven her i R, anden del i hånden)

Vi skal afgøre om $\mathbb{G}$ er et ortogonalt design. Vi har igen som i opgave 2.3 kun to ikke-trivielle sammenligninger at teste; henholdsvis om vi har geometrisk ortogonalitet mellem $S$ og $U$ og mellem $T$ og $S\times U.$
Vi tester den første i R ved den følgende selvlavede funktion;
```{r}
SamhBalanceEquation <- function(x) { 
   #Cannot be used with tablesum function,
   # !!! requires connected components (sammenhængende design). !!!
   sx <- sum(x)
   testy <- x
   rs <- apply(x,1,sum)
   cs <- apply(x,2,sum)
   nuco <- ncol(x)
   nuro <- nrow(x)
   for (i in 1:nuro) {
      for (j in 1:nuco) {
         if (x[i,j]==rs[i]*cs[j]/sx) {
            testy[i,j] <- TRUE
         } else {
         testy[i,j] <- FALSE
       }
      } 
   }
   if (sum(testy) == nuco*nuro) {
      TRUE
   } else {
     FALSE
   }
}
SamhBalanceEquation(table(vaccine$S, vaccine$U)) #TRUE
```
Funktionen tester om sammenhængende designs opfylder balanceligningen, hvilket funktionen siger at tabellen gør. Per L13.11 i EH vil $S$ og $U$ dermed være parvist geometrisk ortogonale. 
Vi har set i opgave 2.3 at tabellen for $T$ og $S\times U$ har balancerede komponenter, således at vi ved Sætning 14.8, Eksempel 14.9 i EH kan konkludere at  $T$ og $S\times U$ også er parvist geometrisk ortogonale.

Tilsammen kan vi dermed konkluderer at vi har med et geometrisk ortogonalt design at gøre.


#### **Opgave 2.5**
(Primære besvarelse af opgaven her i R)

Vi har i opgave 2.2 set at når vi udelukkende betragter antistofresponset i slukningen af perioden, er der ikke signifigant forskel mellem de to vacciner. Vi kan undersøge om der i stedet er forskel mellem vaccinerne, eksempelvis i forhold til, hvor hurtigt de kommer til deres antistofrespons. 

Vi subsetter derfor vores model til kun at være de to ikke-placebo vacciner;
```{r}
vaccinevacciner <- subset(vaccine, vaccine$T %in% c("VZ","KK"))
```
Vi opretter modellen i R
```{r}
interacmodel <- lm(log(X)~Id+U+U:T, data = vaccinevacciner)
summary(interacmodel)
```
Og kan ved at tegne std. res. og qq plot se, at modellen på log-niveau passer antagelser ganske pænt;
```{r}
StdresQQPlot(interacmodel)
```

Vi laver dermed modellen om at der kan være en selvstående individ effekt, en selvstående ugeeffekt, og at der sammentidigt er en interaktionseffekt mellem uge og hvilken vaccine man er blevet givet.

```{r}
anova(interacmodel)
```
I `U:T` linjen i anova testet, tester vi modellen om at der ikke er en interaktionseffekt mellem behandling og uge, mod modellen hvor der ér en interaktionseffekt.

Vi ser en meget lav $p$ værdi således at der i modellen er evidens for at forkaste nul-hypotesen om at der ikke er interaktionseffekt. Vi kan dermed sige at der forekommer evidens for at der er en klar forskel i hvordan de to vacciner virker henover tid. Sammenligner vi med opgave 2.2 vil forskellen i effekten dog efter fem uger være tilstrækkeligt lille til, at vi ikke statistisk kan bemærke forskel.

Vi kan visualiserer denne effekt over tid;
```{r}
ggplot(vaccinevacciner, aes(x = U, y = log(X), color = T)) + stat_summary(aes(group = T), geom = "line", fun = "mean")
```

## **Opgave 3**

#### **Opgave 3.1**
Ikke løst.
#### **Opgave 3.2**
Ikke løst.